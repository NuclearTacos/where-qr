<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>where-qr - QR Code Scanner with Redirect Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-type="module">
        const { useState, useRef, useEffect } = React;
        const { Scan, Link, AlertCircle, CheckCircle, Loader, ExternalLink, Copy, Info } = lucide;

        function App() {
            const [isScanning, setIsScanning] = useState(false);
            const [scannedUrl, setScannedUrl] = useState('');
            const [redirectChain, setRedirectChain] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [copied, setCopied] = useState(null);
            const [debugInfo, setDebugInfo] = useState('');
            const videoRef = useRef(null);
            const streamRef = useRef(null);

            const startScanning = async () => {
                try {
                    if (!('BarcodeDetector' in window)) {
                        setError('QR scanning not supported in this browser. Please use Chrome, Edge, or Opera.');
                        return;
                    }

                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    
                    streamRef.current = stream;
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        await videoRef.current.play();
                    }
                    
                    setIsScanning(true);
                    setError('');
                    detectQR();
                } catch (err) {
                    setError('Camera access denied. Please allow camera permissions.');
                    console.error(err);
                }
            };

            const stopScanning = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                }
                setIsScanning(false);
            };

            const detectQR = async () => {
                if (!videoRef.current || !isScanning) return;
                
                try {
                    const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
                    const barcodes = await barcodeDetector.detect(videoRef.current);
                    
                    if (barcodes.length > 0) {
                        const url = barcodes[0].rawValue;
                        setScannedUrl(url);
                        stopScanning();
                        checkRedirects(url);
                        return;
                    }
                } catch (err) {
                    console.error('QR detection error:', err);
                }
                
                if (isScanning) {
                    setTimeout(detectQR, 100);
                }
            };

            const checkRedirects = async (url) => {
                setLoading(true);
                setRedirectChain([]);
                setError('');
                setDebugInfo('');
                
                try {
                    // Build API URL
                    const apiUrl = `${window.location.origin}/api/track?url=${encodeURIComponent(url)}`;
                    
                    // Debug info
                    setDebugInfo(`Calling API: ${apiUrl}`);
                    console.log('API URL:', apiUrl);
                    console.log('Checking redirects for:', url);
                    
                    const response = await fetch(apiUrl);
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(`API error (${response.status}): ${text}`);
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (data.error) {
                        setError(data.error);
                    } else {
                        setRedirectChain(data.chain || []);
                        setDebugInfo(''); // Clear debug info on success
                    }
                } catch (err) {
                    setError(`Failed to track redirects: ${err.message}`);
                    console.error('Redirect tracking error:', err);
                    
                    // Add fallback info
                    if (err.message.includes('Failed to fetch')) {
                        setDebugInfo('API endpoint may not be deployed. Check Vercel Functions tab.');
                    }
                }
                
                setLoading(false);
            };

            // Add a manual test function
            const testApi = async () => {
                const testUrl = 'https://bit.ly/3xample'; // Example shortened URL
                await checkRedirects(testUrl);
            };

            const copyToClipboard = async (text, index) => {
                try {
                    await navigator.clipboard.writeText(text);
                    setCopied(index);
                    setTimeout(() => setCopied(null), 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };

            const reset = () => {
                setScannedUrl('');
                setRedirectChain([]);
                setError('');
                setDebugInfo('');
            };

            useEffect(() => {
                return () => stopScanning();
            }, []);

            const getStatusColor = (status) => {
                if (status >= 200 && status < 300) return 'text-green-600';
                if (status >= 300 && status < 400) return 'text-blue-600';
                if (status >= 400 && status < 500) return 'text-yellow-600';
                if (status >= 500) return 'text-red-600';
                return 'text-gray-600';
            };

            const getStatusText = (status) => {
                const statusTexts = {
                    200: 'OK',
                    301: 'Moved Permanently',
                    302: 'Found (Temporary Redirect)',
                    303: 'See Other',
                    307: 'Temporary Redirect',
                    308: 'Permanent Redirect',
                    400: 'Bad Request',
                    403: 'Forbidden',
                    404: 'Not Found',
                    500: 'Server Error'
                };
                return statusTexts[status] || `Status ${status}`;
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="container mx-auto px-4 py-8 max-w-2xl">
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">where-qr</h1>
                            <p className="text-gray-600 mb-6">Scan QR codes and track their redirect chains</p>
                            
                            {!isScanning && !scannedUrl && (
                                <div className="text-center py-12">
                                    <Scan className="w-24 h-24 text-gray-400 mx-auto mb-4" />
                                    <button
                                        onClick={startScanning}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 mx-auto"
                                    >
                                        <Scan size={20} />
                                        Start Scanning
                                    </button>
                                    
                                    <div className="mt-4">
                                        <button
                                            onClick={testApi}
                                            className="text-sm text-gray-500 hover:text-gray-700 underline"
                                        >
                                            Test API with sample URL
                                        </button>
                                    </div>
                                </div>
                            )}

                            {isScanning && (
                                <div className="space-y-4">
                                    <div className="relative bg-black rounded-lg overflow-hidden">
                                        <video
                                            ref={videoRef}
                                            className="w-full h-auto"
                                            playsInline
                                            muted
                                        />
                                        <div className="absolute inset-0 border-2 border-blue-400 m-12 rounded-lg animate-pulse" />
                                    </div>
                                    <button
                                        onClick={stopScanning}
                                        className="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700"
                                    >
                                        Cancel Scanning
                                    </button>
                                </div>
                            )}

                            {debugInfo && (
                                <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg mb-4">
                                    <div className="flex items-start gap-2">
                                        <Info className="text-blue-600 mt-0.5" size={16} />
                                        <div className="text-sm text-blue-700">{debugInfo}</div>
                                    </div>
                                </div>
                            )}

                            {error && (
                                <div className="bg-red-50 border border-red-200 p-4 rounded-lg flex items-start gap-3">
                                    <AlertCircle className="text-red-600 mt-0.5" size={20} />
                                    <div className="text-red-700">{error}</div>
                                </div>
                            )}

                            {scannedUrl && (
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-sm font-semibold text-gray-600">Scanned URL:</span>
                                            <button
                                                onClick={() => copyToClipboard(scannedUrl, 'main')}
                                                className="text-gray-500 hover:text-gray-700"
                                            >
                                                {copied === 'main' ? <CheckCircle size={18} /> : <Copy size={18} />}
                                            </button>
                                        </div>
                                        <a
                                            href={scannedUrl}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="text-blue-600 hover:underline break-all flex items-center gap-1"
                                        >
                                            {scannedUrl}
                                            <ExternalLink size={16} />
                                        </a>
                                    </div>

                                    {loading && (
                                        <div className="flex items-center justify-center py-8">
                                            <Loader className="animate-spin text-blue-600" size={32} />
                                        </div>
                                    )}

                                    {redirectChain.length > 0 && (
                                        <div className="space-y-3">
                                            <h3 className="font-semibold text-gray-700">Redirect Chain ({redirectChain.length} steps):</h3>
                                            {redirectChain.map((item, index) => (
                                                <div key={index} className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                                    <div className="flex items-center justify-between mb-1">
                                                        <span className={`font-mono text-sm ${getStatusColor(item.status)}`}>
                                                            {item.status} - {getStatusText(item.status)}
                                                        </span>
                                                        <button
                                                            onClick={() => copyToClipboard(item.url, index)}
                                                            className="text-gray-500 hover:text-gray-700"
                                                        >
                                                            {copied === index ? <CheckCircle size={16} /> : <Copy size={16} />}
                                                        </button>
                                                    </div>
                                                    <div className="text-sm text-gray-600 break-all">
                                                        {index === 0 && '🔗 '}{item.url}
                                                    </div>
                                                    {item.responseTime && (
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            {item.responseTime}ms
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    <button
                                        onClick={reset}
                                        className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                                    >
                                        Scan Another QR Code
                                    </button>
                                </div>
                            )}
                        </div>

                        <div className="mt-4 text-center text-xs text-gray-500">
                            <p>Deployed on: {window.location.hostname}</p>
                            <p>API endpoint: {window.location.origin}/api/track</p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>
